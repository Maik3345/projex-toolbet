name: Publish to npm

on:
  push:
    branches:
      - main
      - master

  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: 'ğŸ” Checkout code'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'ğŸŸ¢ Set up Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: 'ğŸ“¦ Install pnpm'
        run: npm install -g pnpm

      - name: 'ğŸ“¦ Install dependencies'
        run: pnpm install

      - name: 'ğŸ“¦ Install projex globally'
        run: npm install -g projex

      - name: Pre-release version bump (projex)
        run: projex git release stable --yes --no-deploy --no-push --no-check-release --no-tag

      - name: 'ğŸ› ï¸ Build project'
        run: npm run build

      - name: 'ğŸ“¤ Publish to npm'
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  release:
    needs: build-and-publish
    uses: Maik3345/projex-github-actions/.github/workflows/release.yml@main
